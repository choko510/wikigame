<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>Wikipedia ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦</title>
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/common_styles.css') }}">
    <style>
        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼åå…¥åŠ›ç”»é¢ */
        #username-screen h2 {
            margin-bottom: 20px;
            /* h2ã¨å…¥åŠ›æ¬„ã®é–“ã®ãƒãƒ¼ã‚¸ãƒ³èª¿æ•´ */
        }

        #username-screen input[type="text"] {
            margin-bottom: 15px;
            /* å…¥åŠ›æ¬„ã¨ãƒœã‚¿ãƒ³ã®é–“ã®ãƒãƒ¼ã‚¸ãƒ³èª¿æ•´ */
        }

        /* ãƒ­ãƒ“ãƒ¼ç”»é¢ */
        #lobby-screen {
            width: 100%;
        }

        #lobby-screen .card h2,
        #lobby-screen .card h3 {
            margin-bottom: 15px;
        }

        #lobby-screen .card hr {
            margin: 25px 0;
            /* æ°´å¹³ç·šã®ãƒãƒ¼ã‚¸ãƒ³èª¿æ•´ */
            border: none;
            border-top: 1px solid #eee;
        }

        .rooms-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .room-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            /* å°‘ã—ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å¢—ã‚„ã™ */
            transition: all var(--transition-speed) ease;
            cursor: pointer;
            border: 1px solid #e0e0e0;
            /* é€šå¸¸æ™‚ã®ãƒœãƒ¼ãƒ€ãƒ¼ã‚’è–„ãè¡¨ç¤º */
            opacity: 0;
            transform: translateY(20px);
            animation: item-fade-in 0.5s ease forwards;
            display: flex;
            flex-direction: column;
            /* è¦ç´ ã‚’ç¸¦ã«ä¸¦ã¹ã‚‹ */
            justify-content: space-between;
            /* è¦ç´ é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’å‡ç­‰ã« */
            min-height: 150px;
            /* ã‚«ãƒ¼ãƒ‰ã®æœ€å°é«˜ã•ã‚’è¨­å®š */
        }

        .room-card:hover {
            transform: translateY(-3px);
            /* ãƒ›ãƒãƒ¼æ™‚ã®ç§»å‹•é‡ã‚’å°‘ã—æ¸›ã‚‰ã™ */
            border-color: var(--primary-color);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
            /* ãƒ›ãƒãƒ¼æ™‚ã®å½±ã‚’å°‘ã—å¼·èª¿ */
        }

        .room-card h3 {
            margin-bottom: 12px;
            /* ãƒãƒ¼ã‚¸ãƒ³èª¿æ•´ */
            font-size: 1.25em;
            /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºèª¿æ•´ */
            color: var(--primary-color);
        }

        .room-card .room-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
            /* ä¸‹éƒ¨ã«é…ç½® */
            padding-top: 10px;
            /* ä¸Šã®è¦ç´ ã¨ã®é–“ã«ã‚¹ãƒšãƒ¼ã‚¹ */
            border-top: 1px solid #f0f0f0;
            /* åŒºåˆ‡ã‚Šç·š */
        }

        .room-card .status-badge {
            font-size: 0.8em;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .room-card .status-badge.waiting {
            background-color: #e8f5e9;
            /* è–„ã„ç·‘ */
            color: #388e3c;
        }

        .room-card .status-badge.playing {
            background-color: #fff3e0;
            /* è–„ã„ã‚ªãƒ¬ãƒ³ã‚¸ */
            color: #f57c00;
        }

        .room-card .players {
            font-size: 0.9em;
            color: #555;
            font-weight: 500;
        }

        /* ãƒ«ãƒ¼ãƒ ç”»é¢ */
        #room-screen {
            width: 100%;
        }

        .players-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }

        .player-item {
            display: flex;
            align-items: center;
            background-color: var(--card-bg-light);
            /* Slightly lighter card background */
            padding: 12px 15px;
            /* Adjust padding */
            border-radius: var(--border-radius);
            min-width: 220px;
            /* Adjust min-width */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all var(--transition-speed) ease;
        }

        .player-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
        }

        .player-item .username {
            flex: 1;
            font-weight: bold;
        }

        .player-item .status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status.ready {
            background-color: #4CAF50;
            color: white;
        }

        .status.not-ready {
            background-color: #f44336;
            color: white;
        }

        .status.host {
            background-color: #2196F3;
            color: white;
        }

        #target-url-setting {
            /* ãƒ›ã‚¹ãƒˆå°‚ç”¨è¨­å®šã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
            background-color: var(--card-bg-light, #f9f9f9);
            /* --card-bg-light ãŒæœªå®šç¾©ã®å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ */
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 20px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }

        #target-url-setting h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.1em;
            color: var(--primary-color);
        }

        #target-url-setting input[type="text"],
        #target-url-setting select {
            margin-bottom: 10px;
        }

        .room-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
            /* ãƒœã‚¿ãƒ³ãŒè¤‡æ•°è¡Œã«ãªã‚‹å ´åˆã«å¯¾å¿œ */
            justify-content: center;
            /* ãƒœã‚¿ãƒ³ã‚’ä¸­å¤®æƒãˆ */
        }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ */
        #game-screen {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100vh;
            position: relative;
            /* æ”¹å–„ç‚¹: ã‚´ãƒ¼ãƒ«é€šçŸ¥ã®åŸºæº–ã«ã™ã‚‹ãŸã‚ */
        }

        .game-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 12px 20px;
            /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°èª¿æ•´ */
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            /* ãƒ˜ãƒƒãƒ€ãƒ¼å†…ã®è¦ç´ é–“ã®ã‚®ãƒ£ãƒƒãƒ— */
        }

        .game-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 10px 20px;
            /* ã‚®ãƒ£ãƒƒãƒ—èª¿æ•´ (è¡Œé–“ ç¸¦) */
            align-items: center;
        }

        .game-stat {
            font-weight: 600;
            /* Poppins semi-bold */
            text-shadow: none;
            /* ã‚¯ãƒªãƒ¼ãƒ³ãªè¦‹ãŸç›®ã« */
            font-size: 0.9em;
        }

        .game-stat strong {
            /* ç›®æ¨™ãƒšãƒ¼ã‚¸åãªã©ã‚’å¼·èª¿ */
            font-weight: 700;
            color: #ffdd57;
            /* å¼·èª¿è‰² (ä¾‹: é»„è‰²ç³») */
        }

        .game-header-controls {
            /* å›ç­”ãƒ•ã‚©ãƒ¼ãƒ ã¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¡¨ç¤ºãƒœã‚¿ãƒ³ã®ã‚³ãƒ³ãƒ†ãƒŠ */
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #answer-form input[type="text"] {
            margin-bottom: 0;
            /* ãƒ˜ãƒƒãƒ€ãƒ¼å†…ã§ã¯ãƒãƒ¼ã‚¸ãƒ³ä¸è¦ã« */
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            /* å…±é€šã‚¹ã‚¿ã‚¤ãƒ«ã«åˆã‚ã›ã‚‹ã‹ã€ã“ã“ã§æŒ‡å®š */
        }

        #answer-form #submit-answer-btn {
            /* IDã§ç›´æ¥æŒ‡å®š */
            padding: 8px 12px;
        }

        .game-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            position: relative;
            /* æ”¹å–„ç‚¹: iframeæ“ä½œç„¡åŠ¹åŒ–ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®åŸºæº– */
        }

        #game-frame {
            flex: 1;
            border: none;
        }

        /* æ”¹å–„ç‚¹: iframeæ“ä½œç„¡åŠ¹åŒ–ç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #iframe-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.1);
            /* å°‘ã—æš—ãã—ã¦æ“ä½œä¸èƒ½ã‚’è¦–è¦šçš„ã«ç¤ºã™ */
            z-index: 10;
            /* iframeã‚ˆã‚Šæ‰‹å‰ */
            display: none;
            /* é€šå¸¸ã¯éè¡¨ç¤º */
        }

        /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆ (ã‚µã‚¤ãƒ‰ãƒãƒ¼) */
        .sidebar {
            width: 320px;
            /* å°‘ã—å¹…ã‚’åºƒã’ã‚‹ */
            background-color: var(--card-bg-light, #f9f9f9);
            /* ä»–ã®è£œåŠ©çš„èƒŒæ™¯ã¨åˆã‚ã›ã‚‹ */
            border-left: 1px solid #e0e0e0;
            padding: 20px;
            /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°èª¿æ•´ */
            overflow-y: auto;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.05);
            /* å·¦å´ã«å½±ã‚’è¿½åŠ  */
        }

        .sidebar h3 {
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.2em;
            color: var(--primary-color);
        }

        .player-card {
            background-color: var(--card-bg);
            padding: 12px 15px;
            border-radius: var(--border-radius);
            margin-bottom: 12px;
            border: 1px solid #e0e0e0;
            transition: all var(--transition-speed) ease, background-color 0.5s ease;
            opacity: 0;
            transform: translateX(-20px);
            animation: player-card-enter 0.5s ease forwards;
            box-shadow: var(--box-shadow);
        }

        @keyframes player-card-enter {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .player-card .player-name {
            font-weight: 600;
            /* Poppins semi-bold */
            margin-bottom: 8px;
            /* ãƒãƒ¼ã‚¸ãƒ³èª¿æ•´ */
            font-size: 1.05em;
            color: var(--text-color);
        }

        .player-card .player-name .status-text {
            /* (ã‚ãªãŸ) (è„±è½) (âœ“) ã®ã‚¹ã‚¿ã‚¤ãƒ« */
            font-weight: normal;
            font-size: 0.9em;
            color: #777;
        }

        .player-card .player-info-item {
            /* ç§»å‹•å›æ•°ã‚„ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ãªã©ã®æƒ…å ±ã‚¢ã‚¤ãƒ†ãƒ  */
            font-size: 0.85em;
            color: #555;
            margin-bottom: 4px;
        }

        .player-card .player-info-item:last-child {
            margin-bottom: 0;
        }

        .player-card .player-info-item strong {
            /* ãƒ©ãƒ™ãƒ«éƒ¨åˆ† (ä¾‹: "ç§»å‹•å›æ•°:") */
            font-weight: 600;
            color: #333;
        }

        .player-card.finished {
            background-color: #e6ffed;
            /* ã‚ˆã‚Šæ˜ã‚‹ã„ç·‘ */
            border-color: #5cb85c;
            /* å°‘ã—æ¿ƒã„ç·‘ã®ãƒœãƒ¼ãƒ€ãƒ¼ */
        }

        .player-card.finished .player-name {
            color: #1e7e34;
            /* ã‚´ãƒ¼ãƒ«ã—ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åå‰ã®è‰² */
        }

        .player-card.current-player {
            border-color: var(--primary-color);
            background-color: #e9efff;
            /* ã‚ˆã‚Šæ˜ã‚‹ã„é’ */
            box-shadow: 0 0 8px rgba(var(--primary-color-rgb), 0.3);
            /* ãƒ—ãƒ©ã‚¤ãƒãƒªã‚«ãƒ©ãƒ¼ã®RGBå€¤ãŒå¿…è¦ */
        }

        .player-card.eliminated {
            background-color: #fff0f0;
            /* è–„ã„èµ¤ */
            border-color: #f5c6cb;
            /* ã‚„ã‚„æ¿ƒã„èµ¤ã®ãƒœãƒ¼ãƒ€ãƒ¼ */
            opacity: 0.7;
            /* å°‘ã—é€æ˜ã«ã™ã‚‹ */
        }

        .player-card.eliminated .player-name,
        .player-card.eliminated .player-info-item {
            color: #721c24;
            /* è„±è½è€…ã®ãƒ†ã‚­ã‚¹ãƒˆè‰² */
            text-decoration: line-through;
            /* å–ã‚Šæ¶ˆã—ç·š */
        }

        /* æ”¹å–„ç‚¹: ã‚´ãƒ¼ãƒ«é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #goal-notification {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(46, 204, 113, 0.9);
            /* æ˜ã‚‹ã„ç·‘ã€å°‘ã—é€æ˜ */
            color: white;
            padding: 30px 40px;
            border-radius: var(--border-radius);
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            z-index: 100;
            /* iframeã‚ˆã‚Šæ‰‹å‰ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ˆã‚Šå¥¥ */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            display: none;
            /* é€šå¸¸ã¯éè¡¨ç¤º */
            animation: fadeIn 0.5s ease-out;
        }

        #goal-notification p {
            margin: 0;
        }

        #goal-notification .sub-message {
            font-size: 0.7em;
            margin-top: 10px;
            font-weight: normal;
        }

        /* çµæœãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            max-width: 600px;
            width: 90%;
            text-align: center;
            max-height: 90vh;
            overflow-y: auto;
        }

        .leaderboard {
            width: 100%;
            margin: 25px 0;
            /* ãƒãƒ¼ã‚¸ãƒ³èª¿æ•´ */
            border-collapse: collapse;
            border-radius: var(--border-radius);
            /* ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä½“ã«è§’ä¸¸ */
            overflow: hidden;
            /* è§’ä¸¸ã‚’æœ‰åŠ¹ã«ã™ã‚‹ãŸã‚ */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            /* è»½ã„å½± */
        }

        .leaderboard th,
        .leaderboard td {
            padding: 12px 15px;
            /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°èª¿æ•´ */
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            /* ãƒœãƒ¼ãƒ€ãƒ¼è‰²èª¿æ•´ */
        }

        .leaderboard th {
            background-color: var(--primary-color);
            /* ãƒ—ãƒ©ã‚¤ãƒãƒªã‚«ãƒ©ãƒ¼èƒŒæ™¯ */
            color: white;
            font-weight: 600;
            /* Poppins semi-bold */
            font-size: 0.95em;
            text-transform: uppercase;
            /* å¤§æ–‡å­—åŒ– */
            letter-spacing: 0.5px;
        }

        .leaderboard td {
            font-size: 0.9em;
        }

        .leaderboard tr:last-child td {
            border-bottom: none;
            /* æœ€å¾Œã®è¡Œã®ãƒœãƒ¼ãƒ€ãƒ¼ã‚’æ¶ˆã™ */
        }

        /* ä¸Šä½3ä½ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .leaderboard tr.rank-1 td {
            background-color: #fff3cd;
            /* æ·¡ã„é‡‘è‰² */
            color: #664d03;
            font-weight: 600;
        }

        .leaderboard tr.rank-2 td {
            background-color: #f0f0f0;
            /* æ·¡ã„éŠ€è‰² */
            color: #495057;
        }

        .leaderboard tr.rank-3 td {
            background-color: #ffe8d1;
            /* æ·¡ã„éŠ…è‰² */
            color: #723c09;
        }

        .rank {
            /* é †ä½ã‚»ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
            font-weight: 700;
            /* Poppins bold */
            width: 50px;
            /* å¹…èª¿æ•´ */
            text-align: center;
            font-size: 1.1em;
            /* å°‘ã—å¤§ãã */
        }

        .leaderboard tr.rank-1 .rank {
            color: #b38600;
            /* é‡‘è‰²ã®é †ä½ */
        }

        .leaderboard tr.rank-2 .rank {
            color: #6c757d;
            /* éŠ€è‰²ã®é †ä½ */
        }

        .leaderboard tr.rank-3 .rank {
            color: #a0522d;
            /* éŠ…è‰²ã®é †ä½ */
        }

        .confetti {
            position: absolute;
            /* è¦ªè¦ç´ ï¼ˆ.modal-contentï¼‰ã«å¯¾ã—ã¦çµ¶å¯¾é…ç½® */
            width: 10px;
            height: 20px;
            /* animation ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯JSå´ã§è¨­å®š */
            z-index: 1001;
            /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚ˆã‚Šæ‰‹å‰ã«è¡¨ç¤º */
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-10vh) rotate(0deg);
                /* åˆæœŸä½ç½®ã‚’ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã®ä¸Šç«¯ã‚ˆã‚Šå°‘ã—ä¸Šã«ã™ã‚‹ */
                opacity: 1;
            }

            100% {
                transform: translateY(110vh) rotate(720deg);
                /* çµ‚äº†ä½ç½®ã‚’ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã®ä¸‹ç«¯ã‚ˆã‚Šå°‘ã—ä¸‹ã«ã™ã‚‹ */
                opacity: 0;
            }
        }

        /* æ¤œç´¢ã‚µã‚¸ã‚§ã‚¹ãƒˆ */
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
        }

        .suggestion-item:hover {
            background-color: #f8f9fa;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 2px;
        }

        .suggestion-url {
            font-size: 0.8em;
            color: #666;
            word-break: break-all;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Wikipedia ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦</h1>

        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼åå…¥åŠ›ç”»é¢ -->
        <div id="username-screen" class="card">
            <h2>ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h2>
            <input type="text" id="username-input" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å">
            <button id="submit-username" class="btn">å‚åŠ ã™ã‚‹</button>
        </div>

        <!-- ãƒ­ãƒ“ãƒ¼ç”»é¢ -->
        <div id="lobby-screen" class="hidden">
            <div class="card">
                <h2>ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã¾ãŸã¯å‚åŠ </h2>
                <button id="create-room-btn" class="btn">æ–°ã—ã„ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ</button>
                <hr style="margin: 20px 0; opacity: 0.2;">
                <h3>åˆ©ç”¨å¯èƒ½ãªãƒ«ãƒ¼ãƒ </h3>
                <button id="refresh-rooms-btn" class="btn" style="margin-bottom: 10px;">æ›´æ–°</button>
                <div id="rooms-list" class="rooms-container">
                    <!-- ãƒ«ãƒ¼ãƒ ãŒå‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
                </div>
            </div>
        </div>

        <!-- ãƒ«ãƒ¼ãƒ ç”»é¢ -->
        <div id="room-screen" class="hidden">
            <div class="card">
                <h2>ãƒ«ãƒ¼ãƒ : <span id="room-name"></span></h2>
                <div id="room-status"></div>
                <div id="target-url-setting" class="hidden" style="margin-top: 15px;">
                    <h3>ã‚²ãƒ¼ãƒ è¨­å®š (ãƒ›ã‚¹ãƒˆã®ã¿)</h3>
                    <div id="target-url-input-section">
                        <div style="position: relative;">
                            <input type="text" id="room-target-search-input" placeholder="ç›®æ¨™ãƒšãƒ¼ã‚¸ã‚’æ¤œç´¢ï¼ˆä¾‹ï¼šæ±äº¬ã€å¯Œå£«å±±ï¼‰"
                                style="width: 100%; margin-bottom: 5px;">
                            <div id="search-suggestions" class="search-suggestions hidden"></div>
                        </div>
                        <input type="text" id="room-target-url-input" placeholder="ã¾ãŸã¯ç›´æ¥Wikipedia URLã‚’å…¥åŠ›"
                            style="margin-top: 10px;">
                        <button id="set-target-url-btn" class="btn">ç›®æ¨™ã‚’è¨­å®š</button>
                    </div>
                    <div style="margin-top: 10px;">
                        <label for="allow-ctrl-f-checkbox">
                            <input type="checkbox" id="allow-ctrl-f-checkbox" checked> Ctrl+F (ãƒšãƒ¼ã‚¸å†…æ¤œç´¢) ã‚’è¨±å¯ã™ã‚‹
                        </label>
                        <div style="margin-top: 10px;">
                            <label>ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰: </label>
                            <select id="game-mode-select" style="padding: 5px; border-radius: 4px;">
                                <option value="navigation">ç›®æ¨™ãƒšãƒ¼ã‚¸ã«è¾¿ã‚Šç€ããƒ¢ãƒ¼ãƒ‰</option>
                                <option value="guessing">ãƒšãƒ¼ã‚¸åå½“ã¦ãƒ¢ãƒ¼ãƒ‰</option>
                            </select>
                        </div>
                        <div id="difficulty-selection-multiplayer" class="hidden" style="margin-top: 10px;">
                            <label>é›£æ˜“åº¦: </label>
                            <select id="difficulty-select" style="padding: 5px; border-radius: 4px;">
                                <option value="easy">Easy</option>
                                <option value="medium">Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>
                    </div>
                </div>
                <p>ç¾åœ¨ã®ç›®æ¨™ãƒšãƒ¼ã‚¸: <strong id="current-room-target-url">æœªè¨­å®š</strong></p>

                <h3>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§</h3>
                <div id="players-list" class="players-list">
                    <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
                </div>

                <div class="room-controls">
                    <button id="toggle-ready-btn" class="btn">æº–å‚™å®Œäº†</button>
                    <button id="start-game-btn" class="btn" disabled>ã‚²ãƒ¼ãƒ é–‹å§‹</button>
                    <button id="leave-room-btn" class="btn">ãƒ«ãƒ¼ãƒ ã‚’é€€å‡º</button>
                </div>
            </div>
        </div>

        <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
        <div id="game-screen" class="hidden">
            <div class="game-header">
                <div class="game-stats">
                    <div id="game-moves" class="game-stat">ç§»å‹•å›æ•°: 0</div>
                    <div id="game-guess-count" class="game-stat hidden">æ¨æ¸¬å›æ•°: 0</div>
                    <div id="game-mode-display" class="game-stat">ãƒ¢ãƒ¼ãƒ‰: ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³</div>
                    <div id="target-display" class="game-stat">
                        <span id="navigation-target">ç›®æ¨™ã®ãƒšãƒ¼ã‚¸: <strong id="target-page-name">æ—¥æœ¬</strong></span>
                        <span id="guessing-target" class="hidden">ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã®åå‰ã‚’å½“ã¦ã¦ãã ã•ã„</span>
                    </div>
                    <div id="current-time" class="game-stat">çµŒéæ™‚é–“: 00:00</div>
                </div>
                <div class="game-header-controls">
                    <button id="view-players-btn" class="btn btn-small"
                        style="padding: 8px 12px; display: none;">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¡¨ç¤º</button>
                    <button id="give-up-btn" class="btn btn-small"
                        style="padding: 8px 12px; background-color: #f44336; color: white; display: none;">ã‚®ãƒ–ã‚¢ãƒƒãƒ—</button>
                    <div id="answer-form" class="hidden" style="display: flex; gap: 5px;">
                        <input type="text" id="answer-input" placeholder="ãƒšãƒ¼ã‚¸åã‚’å…¥åŠ›">
                        <button id="submit-answer-btn" class="btn">å›ç­”</button>
                    </div>
                </div>
            </div>

            <div class="game-container">
                <iframe id="game-frame" src=""></iframe>
                <!-- æ”¹å–„ç‚¹: iframeæ“ä½œç„¡åŠ¹åŒ–ç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
                <div id="iframe-overlay"></div>
                <div id="players-sidebar" class="sidebar">
                    <h3>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é€²æ—</h3>
                    <div id="player-progress-list">
                        <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é€²æ—ãŒå‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
                    </div>
                </div>
            </div>
            <!-- æ”¹å–„ç‚¹: ã‚´ãƒ¼ãƒ«é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <div id="goal-notification">
                <p id="goal-notification-main-text"></p>
                <p id="goal-notification-sub-text" class="sub-message"></p>
            </div>
        </div>

        <!-- çµæœãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="results-modal" class="modal hidden">
            <div class="modal-content">
                <h2>ã‚²ãƒ¼ãƒ çµæœ</h2>
                <table class="leaderboard">
                    <thead>
                        <tr>
                            <th>é †ä½</th>
                            <th>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</th>
                            <th>ç§»å‹•å›æ•°</th>
                            <th>ã‚¿ã‚¤ãƒ </th>
                            <th>ãƒ«ãƒ¼ãƒˆ</th>
                        </tr>
                    </thead>
                    <tbody id="results-table-body">
                        <!-- çµæœãŒå‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
                    </tbody>
                </table>
                <!-- ãƒœã‚¿ãƒ³ã¯ showResults ã§å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ã‚ˆã†ã«å¤‰æ›´æ¸ˆã¿ -->
            </div>
        </div>
    </div>

    <script>
        // ã‚½ã‚±ãƒƒãƒˆæ¥ç¶š
        let socket;
        let playerId;
        let roomId;
        let isHost = false;
        let username = '';
        let moveCount = 0; // UIè¡¨ç¤ºç”¨ã€‚å®Ÿè³ªçš„ãªã‚«ã‚¦ãƒ³ãƒˆã¯ã‚µãƒ¼ãƒãƒ¼ã€‚
        let guessCount = 0;
        let startUrl = '';
        let targetUrl = '';
        let currentPage = '';
        let gamePath = [];
        let roomSettings = {
            allow_ctrl_f: true,
            game_mode: 'navigation'
        };
        let ctrlFWarningShown = false;
        let gameStartTime = 0;
        let timerInterval = null;

        let currentRoomPlayerInfos = {};
        let latestGameState = null; // â˜… 1. ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®è¿½åŠ 

        // ç”»é¢è¦ç´ ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ (DOMContentLoadedå¾ŒãŒè‰¯ã„ãŒã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã“ã“ã§å®£è¨€)
        let usernameScreen, lobbyScreen, roomScreen, gameScreen, resultsModal;
        let goalNotification, iframeOverlay; // æ”¹å–„ç‚¹: æ–°ã—ã„UIè¦ç´ 

        document.addEventListener('DOMContentLoaded', () => {
            // ç”»é¢è¦ç´ ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
            usernameScreen = document.getElementById('username-screen');
            lobbyScreen = document.getElementById('lobby-screen');
            roomScreen = document.getElementById('room-screen');
            gameScreen = document.getElementById('game-screen');
            resultsModal = document.getElementById('results-modal');
            goalNotification = document.getElementById('goal-notification'); // æ”¹å–„ç‚¹
            iframeOverlay = document.getElementById('iframe-overlay'); // æ”¹å–„ç‚¹

            setupGlobalCtrlFDetection();

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼åå…¥åŠ›
            document.getElementById('submit-username').addEventListener('click', function () {
                username = document.getElementById('username-input').value.trim();
                if (username) {
                    initSocketConnection();
                    switchScreen(usernameScreen, lobbyScreen);
                    loadAvailableRooms();
                } else {
                    alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                }
            });

            // ãƒ­ãƒ“ãƒ¼æ“ä½œãƒœã‚¿ãƒ³
            document.getElementById('create-room-btn').addEventListener('click', function () {
                socket.emit('create_room', { username: username });
            });
            document.getElementById('refresh-rooms-btn').addEventListener('click', function () {
                loadAvailableRooms();
            });

            // ãƒ«ãƒ¼ãƒ æ“ä½œãƒœã‚¿ãƒ³
            document.getElementById('toggle-ready-btn').addEventListener('click', function () {
                socket.emit('toggle_ready');
            });
            document.getElementById('start-game-btn').addEventListener('click', function () {
                socket.emit('start_game');
            });
            document.getElementById('leave-room-btn').addEventListener('click', function () {
                socket.emit('leave_room_request');
            });

            // ãƒ›ã‚¹ãƒˆè¨­å®š
            document.getElementById('set-target-url-btn').addEventListener('click', function () {
                let newTargetUrl = document.getElementById('room-target-url-input').value.trim();
                if (!newTargetUrl) {
                    const searchQuery = document.getElementById('room-target-search-input').value.trim();
                    if (searchQuery) {
                        alert('æ¤œç´¢çµæœã‹ã‚‰é¸æŠã™ã‚‹ã‹ã€ç›´æ¥URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }
                }
                if (!newTargetUrl || !isValidWikipediaArticle(newTargetUrl)) {
                    alert('æœ‰åŠ¹ãªWikipediaã®ç›®æ¨™ãƒšãƒ¼ã‚¸URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                if (roomId) {
                    socket.emit('set_target_url', { room_id: roomId, target_url: newTargetUrl });
                }
            });
            document.getElementById('allow-ctrl-f-checkbox').addEventListener('change', function () {
                if (isHost && roomId) {
                    socket.emit('update_room_settings', {
                        room_id: roomId,
                        settings: { allow_ctrl_f: this.checked }
                    });
                }
            });
            document.getElementById('game-mode-select').addEventListener('change', function () {
                const gameMode = this.value;
                const difficultySelection = document.getElementById('difficulty-selection-multiplayer');
                const targetUrlSection = document.getElementById('target-url-input-section');
                if (gameMode === 'guessing') {
                    difficultySelection.classList.remove('hidden');
                    targetUrlSection.classList.add('hidden');
                } else {
                    difficultySelection.classList.add('hidden');
                    targetUrlSection.classList.remove('hidden');
                }
                if (isHost && roomId) {
                    const settings = { game_mode: gameMode };
                    if (gameMode === 'guessing') {
                        settings.difficulty = document.getElementById('difficulty-select').value;
                    }
                    socket.emit('update_room_settings', { room_id: roomId, settings: settings });
                }
            });
            document.getElementById('difficulty-select').addEventListener('change', function () {
                if (isHost && roomId) {
                    socket.emit('update_room_settings', {
                        room_id: roomId,
                        settings: { difficulty: this.value }
                    });
                }
            });

            // æ¤œç´¢ã‚µã‚¸ã‚§ã‚¹ãƒˆ
            const searchInput = document.getElementById('room-target-search-input');
            const suggestionsDiv = document.getElementById('search-suggestions');
            searchInput.addEventListener('input', function () {
                const query = this.value.trim();
                clearTimeout(searchTimeout);
                if (query.length < 2) {
                    suggestionsDiv.classList.add('hidden');
                    return;
                }
                searchTimeout = setTimeout(() => { searchWikipedia(query); }, 300);
            });
            document.addEventListener('click', function (e) {
                if (!searchInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                    suggestionsDiv.classList.add('hidden');
                }
            });

            // ã‚²ãƒ¼ãƒ ç”»é¢æ“ä½œ
            const viewPlayersBtn = document.getElementById('view-players-btn');
            if (viewPlayersBtn) {
                viewPlayersBtn.addEventListener('click', function () {
                    document.getElementById('players-sidebar').classList.toggle('hidden');
                });
            }
            
            // ã‚®ãƒ–ã‚¢ãƒƒãƒ—ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('give-up-btn').addEventListener('click', function () {
                showGiveUpConfirmDialog();
            });
            document.getElementById('game-frame').addEventListener('load', handleFrameLoad);
            document.getElementById('submit-answer-btn').addEventListener('click', submitAnswer);
            document.getElementById('answer-input').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    submitAnswer();
                }
            });
        });

        function setupGlobalCtrlFDetection() {
            document.addEventListener('keydown', function (e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                    if (gameScreen && !gameScreen.classList.contains('hidden') && roomSettings && !roomSettings.allow_ctrl_f) {
                        e.preventDefault();
                        e.stopPropagation();
                        if (!ctrlFWarningShown) {
                            socket.emit('ctrl_f_violation');
                            showCtrlFViolationDialog(); // è‡ªåˆ†ã¸ã®è­¦å‘Š
                        }
                        return false;
                    }
                }
            });
        }

        function showCtrlFViolationDialog() {
            ctrlFWarningShown = true;
            const dialog = document.createElement('div');
            dialog.className = 'modal';
            dialog.style.zIndex = '2000';
            const content = document.createElement('div');
            content.className = 'modal-content';
            content.style.maxWidth = '400px';
            content.style.backgroundColor = '#ffebee';
            content.style.border = '2px solid #e57373';
            const title = document.createElement('h3');
            title.textContent = 'âš ï¸ãƒšãƒ¼ã‚¸å†…æ¤œç´¢ä½¿ç”¨æ¤œå‡º';
            title.style.color = '#d32f2f';
            const message = document.createElement('p');
            message.textContent = 'ã“ã®ãƒ«ãƒ¼ãƒ ã§ã¯ãƒšãƒ¼ã‚¸å†…æ¤œç´¢(Ctrl+F)ã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ«ãƒ¼ãƒ«é•åã«ã‚ˆã‚Šè„±è½ã¨ãªã‚Šã¾ã™ã€‚';
            message.style.marginBottom = '20px';
            const buttonDiv = document.createElement('div');
            buttonDiv.style.textAlign = 'center';
            const okButton = document.createElement('button');
            okButton.className = 'btn';
            okButton.textContent = 'äº†è§£ã—ã¾ã—ãŸ';
            okButton.style.backgroundColor = '#d32f2f';
            okButton.onclick = function () { dialog.remove(); };
            buttonDiv.appendChild(okButton);
            content.appendChild(title);
            content.appendChild(message);
            content.appendChild(buttonDiv);
            dialog.appendChild(content);
            document.body.appendChild(dialog);
        }

        function showCtrlFWarningDialogOnGameStart() {
            const dialog = document.createElement('div');
            dialog.className = 'modal';
            dialog.style.zIndex = '1999';
            const content = document.createElement('div');
            content.className = 'modal-content';
            content.style.maxWidth = '450px';
            content.style.backgroundColor = '#fffde7';
            content.style.border = '2px solid #fbc02d';
            const title = document.createElement('h3');
            title.textContent = 'ğŸ›¡ï¸ ãƒšãƒ¼ã‚¸å†…æ¤œç´¢ (Ctrl+F) ã«ã¤ã„ã¦';
            title.style.color = '#f57f17';
            const message = document.createElement('p');
            message.innerHTML = 'ã“ã®ã‚²ãƒ¼ãƒ ã§ã¯ãƒšãƒ¼ã‚¸å†…æ¤œç´¢(Ctrl+F ã¾ãŸã¯ Cmd+F)ã¯<strong>ç¦æ­¢</strong>ã•ã‚Œã¦ã„ã¾ã™ã€‚<br>ä½¿ç”¨ãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆã€ãƒšãƒŠãƒ«ãƒ†ã‚£ã¨ã—ã¦è„±è½ã¨ãªã‚Šã¾ã™ã®ã§ã”æ³¨æ„ãã ã•ã„ã€‚';
            message.style.marginBottom = '20px';
            message.style.lineHeight = '1.6';
            const buttonDiv = document.createElement('div');
            buttonDiv.style.textAlign = 'center';
            const okButton = document.createElement('button');
            okButton.className = 'btn';
            okButton.textContent = 'ãƒ«ãƒ¼ãƒ«ã‚’ç†è§£ã—ã¾ã—ãŸ';
            okButton.style.backgroundColor = '#fbc02d';
            okButton.style.color = '#333';
            okButton.onclick = function () { dialog.remove(); };
            buttonDiv.appendChild(okButton);
            content.appendChild(title);
            content.appendChild(message);
            content.appendChild(buttonDiv);
            dialog.appendChild(content);
            document.body.appendChild(dialog);
        }

        function initSocketConnection() {
            socket = io();

            socket.on('connect', () => console.log('Socket connected'));
            socket.on('connection_response', data => { playerId = data.player_id; console.log('Connected as', playerId); });

            socket.on('room_created', data => {
                roomId = data.room_id;
                isHost = true;
                currentRoomPlayerInfos = data.room_info.player_info || {};
                switchScreen(lobbyScreen, roomScreen);
                updateRoomInfo(data.room_info);
            });

            socket.on('player_joined', data => {
                if (data.player_id === playerId && data.room_info && data.room_info.id) {
                    roomId = data.room_info.id;
                    switchScreen(lobbyScreen, roomScreen);
                }
                if (data.room_info && data.room_info.id === roomId) {
                    currentRoomPlayerInfos = data.room_info.player_info || {};
                    updateRoomInfo(data.room_info);
                }
            });

            socket.on('player_ready_changed', data => {
                if (data.room_info && data.room_info.id === roomId) {
                    currentRoomPlayerInfos = data.room_info.player_info || {};
                    updateRoomInfo(data.room_info);
                }
            });

            socket.on('all_players_ready', data => {
                if (isHost) document.getElementById('start-game-btn').disabled = false;
            });

            socket.on('target_url_updated', data => {
                if (data.room_id === roomId) {
                    currentRoomPlayerInfos = data.room_info.player_info || {};
                    updateRoomInfo(data.room_info);
                    if (data.room_info && data.room_info.target_url) {
                        document.getElementById('current-room-target-url').textContent = decodeURIComponent(data.room_info.target_url).split('/').pop() || 'æœªè¨­å®š';
                    }
                    if (data.room_info && data.room_info.settings) {
                        roomSettings = data.room_info.settings;
                        updateCtrlFCheckbox(roomSettings.allow_ctrl_f);
                    }
                }
            });

            socket.on('room_settings_updated', data => {
                if (data.room_id === roomId) {
                    roomSettings = data.settings;
                    currentRoomPlayerInfos = data.room_info.player_info || {};
                    updateRoomInfo(data.room_info);
                }
            });

            socket.on('game_started', data => {
                if (data.room_settings) roomSettings = data.room_settings;
                currentRoomPlayerInfos = (data.room_info && data.room_info.player_info) ||
                    (data.game_state && data.game_state.player_states
                        ? Object.fromEntries(Object.entries(data.game_state.player_states).map(([pid, state]) => [pid, { username: state.username, id: pid }]))
                        : {});

                // â˜… 2. latestGameState ã®æ›´æ–°
                if (data.game_state) latestGameState = data.game_state;

                startGame(data);

                const gameHeaderStats = document.querySelector('.game-header .game-stats');
                let ctrlFStatusDiv = document.getElementById('ctrl-f-status');
                if (!ctrlFStatusDiv && gameHeaderStats) {
                    ctrlFStatusDiv = document.createElement('div');
                    ctrlFStatusDiv.id = 'ctrl-f-status';
                    ctrlFStatusDiv.className = 'game-stat';
                    if (!roomSettings.allow_ctrl_f) {
                        ctrlFStatusDiv.style.color = '#f44336';
                        ctrlFStatusDiv.style.fontWeight = 'bold';
                    }
                    gameHeaderStats.appendChild(ctrlFStatusDiv);
                }
                if (ctrlFStatusDiv) {
                    ctrlFStatusDiv.textContent = `ãƒšãƒ¼ã‚¸å†…æ¤œç´¢: ${roomSettings.allow_ctrl_f ? 'è¨±å¯' : 'ç¦æ­¢'}`;
                }

                if (!roomSettings.allow_ctrl_f) showCtrlFWarningDialogOnGameStart();
                ctrlFWarningShown = false;
            });

            socket.on('player_eliminated', data => {
                // â˜… 2. latestGameState ã®æ›´æ–°
                if (data.game_state) {
                    latestGameState = data.game_state;
                    updateAllPlayersProgress(data.game_state);
                }

                const eliminatedPlayerInfo = currentRoomPlayerInfos[data.player_id];
                const playerName = eliminatedPlayerInfo ? eliminatedPlayerInfo.username : `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ (${data.player_id.substring(0, 4)}...)`;

                if (data.player_id === playerId) {
                    showCtrlFViolationDialog();
                    if (iframeOverlay) iframeOverlay.style.display = 'block'; // æ”¹å–„ç‚¹: è„±è½è€…ã¯æ“ä½œä¸èƒ½ã«
                    
                    // ã‚®ãƒ–ã‚¢ãƒƒãƒ—ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
                    const giveUpBtn = document.getElementById('give-up-btn');
                    if (giveUpBtn) giveUpBtn.style.display = 'none';
                } else {
                    showEliminationToast(playerName);
                }
                console.log('Player eliminated:', data.player_id, data.elimination_reason);
            });

            socket.on('player_moved', data => {
                if (data.player_id === playerId) {
                    moveCount = data.moves;
                    currentPage = data.url;
                    gamePath.push(data.url);
                    updateStats();
                }
                // â˜… 2. latestGameState ã®æ›´æ–°
                if (data.game_state) {
                    latestGameState = data.game_state;
                    updateAllPlayersProgress(data.game_state);
                }
            });

            socket.on('player_finished', data => {
                // â˜… 2. latestGameState ã®æ›´æ–°
                if (data.game_state) latestGameState = data.game_state;
                playerFinished(data);
            });

            socket.on('game_finished', data => {
                if (timerInterval) clearInterval(timerInterval);
                latestGameState = null; // ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚ã¯ãƒªã‚»ãƒƒãƒˆ
                showResults(data);
                hideGoalNotification();
                if (iframeOverlay) iframeOverlay.style.display = 'none';
                
                // ã‚®ãƒ–ã‚¢ãƒƒãƒ—ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
                const giveUpBtn = document.getElementById('give-up-btn');
                if (giveUpBtn) giveUpBtn.style.display = 'none';
            });

            socket.on('player_left', data => {
                if (data.room_info && data.room_info.id === roomId) {
                    currentRoomPlayerInfos = data.room_info.player_info || {};
                    updateRoomInfo(data.room_info);
                }
                // ã‚²ãƒ¼ãƒ ä¸­ã«èª°ã‹ãŒæŠœã‘ãŸå ´åˆã€æœ€æ–°ã®ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚‚æ›´æ–°ã•ã‚Œã‚‹ã¹ã (ã‚µãƒ¼ãƒãƒ¼å´ã§é€ä¿¡ã•ã‚Œã¦ã„ã‚Œã°)
                if (data.game_state) latestGameState = data.game_state;
                
                // ã‚²ãƒ¼ãƒ ä¸­ã«ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ãŒé›¢è„±ã—ãŸå ´åˆã®å‡¦ç†
                if (data.during_game && !gameScreen.classList.contains('hidden')) {
                    const leftPlayerInfo = currentRoomPlayerInfos[data.player_id] || {};
                    const playerName = leftPlayerInfo.username || `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ (${data.player_id.substring(0, 4)}...)`;
                    showPlayerLeftToast(playerName);
                    
                    // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’æ›´æ–°
                    if (data.game_state) {
                        latestGameState = data.game_state;
                        updateAllPlayersProgress(data.game_state);
                    }
                }
            });

            socket.on('player_gave_up', data => {
                // â˜… 2. latestGameState ã®æ›´æ–°
                if (data.game_state) {
                    latestGameState = data.game_state;
                    updateAllPlayersProgress(data.game_state);
                }

                const gaveUpPlayerInfo = currentRoomPlayerInfos[data.player_id];
                const playerName = gaveUpPlayerInfo ? gaveUpPlayerInfo.username : `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ (${data.player_id.substring(0, 4)}...)`;

                if (data.player_id === playerId) {
                    // è‡ªåˆ†ãŒã‚®ãƒ–ã‚¢ãƒƒãƒ—ã—ãŸå ´åˆã®å‡¦ç†ã¯ handleGiveUp() ã§æ—¢ã«å®Ÿè¡Œæ¸ˆã¿
                } else {
                    showPlayerGaveUpToast(playerName);
                }
                console.log('Player gave up:', data.player_id);
            });

            // ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ä¸è¶³ã«ã‚ˆã‚‹ã‚²ãƒ¼ãƒ å¼·åˆ¶çµ‚äº†ã¯å‰Šé™¤ï¼ˆã‚²ãƒ¼ãƒ ã¯ç¶™ç¶šï¼‰

            socket.on('left_room', () => {
                switchScreen(roomScreen, lobbyScreen);
                roomId = null;
                isHost = false;
                currentRoomPlayerInfos = {};
                latestGameState = null; // ãƒ­ãƒ“ãƒ¼ã«æˆ»ã£ãŸã‚‰ãƒªã‚»ãƒƒãƒˆ
                loadAvailableRooms();
            });

            socket.on('available_rooms', data => displayAvailableRooms(data.rooms));

            socket.on('room_reset', data => {
                if (data.room_id === roomId) {
                    if (!gameScreen.classList.contains('hidden')) switchScreen(gameScreen, roomScreen);
                    if (!resultsModal.classList.contains('hidden')) resultsModal.classList.add('hidden');

                    currentRoomPlayerInfos = data.room_info.player_info || {};
                    latestGameState = null; // ãƒ«ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆæ™‚ã‚‚
                    updateRoomInfo(data.room_info);
                    hideGoalNotification();
                    if (iframeOverlay) iframeOverlay.style.display = 'none';

                    const toast = document.createElement('div');
                    toast.style.cssText = 'position:fixed; top:20px; left:50%; transform:translateX(-50%); background-color:#e8f5e9; color:#2e7d32; padding:10px 20px; border-radius:5px; box-shadow:0 2px 4px rgba(0,0,0,0.2); font-weight:bold; z-index:9999;';
                    toast.innerHTML = 'ğŸ”„ ãƒ«ãƒ¼ãƒ ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸã€‚æ–°ã—ã„ã‚²ãƒ¼ãƒ ã®æº–å‚™ã‚’ã—ã¦ãã ã•ã„ã€‚';
                    document.body.appendChild(toast);
                    setTimeout(() => {
                        toast.style.opacity = '0';
                        toast.style.transition = 'opacity 0.5s ease';
                        setTimeout(() => toast.remove(), 500);
                    }, 3000);
                }
            });
            socket.on('error', data => alert(data.message));

            // ãƒšãƒ¼ã‚¸åå½“ã¦ãƒ¢ãƒ¼ãƒ‰ç”¨
            socket.on('answer_result', data => {
                guessCount = data.guess_count;
                updateStats();
                // â˜… 2. latestGameState ã®æ›´æ–° (ã‚µãƒ¼ãƒãƒ¼ãŒ game_state ã‚’é€ã£ã¦ãã‚Œã°)
                if (data.game_state) latestGameState = data.game_state;

                if (data.is_correct) {
                    showCorrectAnswerDialog(data.correct_title);
                    if (data.next_page_url) {
                        navigateToPage(data.next_page_url, true);
                    }
                } else {
                    showWrongAnswerDialog();
                }
            });
            socket.on('player_answered_correctly', data => {
                const answeredPlayerInfo = currentRoomPlayerInfos[data.player_id];
                const playerName = answeredPlayerInfo ? answeredPlayerInfo.username : `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ (${data.player_id.substring(0, 4)}...)`;
                if (data.player_id !== playerId) showPlayerAnsweredToast(playerName);
                // â˜… 2. latestGameState ã®æ›´æ–°
                if (data.game_state) {
                    latestGameState = data.game_state;
                    updateAllPlayersProgress(data.game_state);
                }
            });
        }

        function loadAvailableRooms() { socket.emit('get_available_rooms'); }

        function displayAvailableRooms(roomsData) {
            const roomsList = document.getElementById('rooms-list');
            roomsList.innerHTML = '';
            if (roomsData.length === 0) {
                roomsList.innerHTML = '<p>åˆ©ç”¨å¯èƒ½ãªãƒ«ãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            roomsData.forEach((room, index) => {
                const roomCard = document.createElement('div');
                roomCard.className = 'room-card';
                roomCard.style.animationDelay = `${index * 0.1}s`;
                const h3 = document.createElement('h3');
                h3.textContent = room.name;
                const roomMetaDiv = document.createElement('div');
                roomMetaDiv.className = 'room-meta';
                const statusBadge = document.createElement('span');
                statusBadge.className = `status-badge ${room.status === 'waiting' ? 'waiting' : 'playing'}`;
                statusBadge.textContent = room.status === 'waiting' ? 'å¾…æ©Ÿä¸­' : 'ã‚²ãƒ¼ãƒ ä¸­';
                const playersDiv = document.createElement('div');
                playersDiv.className = 'players';
                playersDiv.textContent = `${room.player_count} / ${room.max_players}äºº`;
                roomMetaDiv.appendChild(statusBadge);
                roomMetaDiv.appendChild(playersDiv);
                roomCard.appendChild(h3);
                roomCard.appendChild(roomMetaDiv);
                roomCard.addEventListener('click', () => socket.emit('join_room', { room_id: room.id, username: username }));
                roomsList.appendChild(roomCard);
            });
        }

        function updateRoomInfo(roomInfo) {
            if (!roomInfo || !roomInfo.name) { console.warn('updateRoomInfo: roomInfo is invalid', roomInfo); return; }
            document.getElementById('room-name').textContent = roomInfo.name;
            const playersListElement = document.getElementById('players-list');
            playersListElement.innerHTML = '';
            if (roomInfo.player_info && roomInfo.players) {
                roomInfo.players.forEach(pId => {
                    const playerDetail = roomInfo.player_info[pId];
                    if (playerDetail) {
                        const isHostPlayer = pId === roomInfo.host;
                        const playerItem = document.createElement('div');
                        playerItem.className = 'player-item';
                        const usernameDiv = document.createElement('div');
                        usernameDiv.className = 'username';
                        usernameDiv.textContent = `${playerDetail.username} ${pId === playerId ? '(ã‚ãªãŸ)' : ''}`;
                        const statusDiv = document.createElement('div');
                        statusDiv.className = `status ${playerDetail.ready ? 'ready' : (isHostPlayer ? 'host' : 'not-ready')}`;
                        statusDiv.textContent = isHostPlayer ? 'ãƒ›ã‚¹ãƒˆ' : (playerDetail.ready ? 'æº–å‚™å®Œäº†' : 'æº–å‚™ä¸­');
                        playerItem.appendChild(usernameDiv);
                        playerItem.appendChild(statusDiv);
                        playersListElement.appendChild(playerItem);
                    }
                });
            }

            const startGameBtn = document.getElementById('start-game-btn');
            const toggleReadyBtn = document.getElementById('toggle-ready-btn');
            if (playerId === roomInfo.host) {
                isHost = true;
                startGameBtn.style.display = 'inline-block';
                toggleReadyBtn.style.display = 'none';
                const otherPlayerIds = roomInfo.players.filter(pId => pId !== playerId);
                const allOtherPlayersReady = otherPlayerIds.length > 0 && otherPlayerIds.every(pIdVal => roomInfo.player_info[pIdVal] && roomInfo.player_info[pIdVal].ready);
                startGameBtn.disabled = !(allOtherPlayersReady && roomInfo.players.length >= 1); // ãƒ›ã‚¹ãƒˆã®ã¿ã§ã‚‚é–‹å§‹å¯èƒ½ã«ã™ã‚‹å ´åˆ >=1
            } else {
                isHost = false;
                startGameBtn.style.display = 'none';
                toggleReadyBtn.style.display = 'inline-block';
            }

            document.getElementById('room-status').textContent = `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${roomInfo.status === 'waiting' ? 'å¾…æ©Ÿä¸­' : 'ã‚²ãƒ¼ãƒ ä¸­'} - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: ${roomInfo.players.length}/${roomInfo.max_players}`;
            document.getElementById('current-room-target-url').textContent = decodeURIComponent(roomInfo.target_url || 'https://ja.wikipedia.org/wiki/æ—¥æœ¬').split('/').pop() || 'æœªè¨­å®š';

            const targetUrlSettingDiv = document.getElementById('target-url-setting');
            const ctrlFCheckbox = document.getElementById('allow-ctrl-f-checkbox');
            const gameModeSelect = document.getElementById('game-mode-select');
            const difficultySelect = document.getElementById('difficulty-select');
            const difficultySelection = document.getElementById('difficulty-selection-multiplayer');
            const targetUrlSection = document.getElementById('target-url-input-section');

            if (isHost) {
                targetUrlSettingDiv.classList.remove('hidden');
                document.getElementById('room-target-url-input').value = roomInfo.target_url || '';
                document.getElementById('room-target-search-input').value = roomInfo.target_url ? decodeURIComponent(roomInfo.target_url).split('/').pop().replace(/_/g, ' ') : '';
                ctrlFCheckbox.disabled = false;
                ctrlFCheckbox.checked = roomInfo.settings ? roomInfo.settings.allow_ctrl_f : true;
                gameModeSelect.disabled = false;
                difficultySelect.disabled = false;
                gameModeSelect.value = roomInfo.settings ? roomInfo.settings.game_mode || 'navigation' : 'navigation';
                difficultySelect.value = roomInfo.settings ? roomInfo.settings.difficulty || 'easy' : 'easy';
                if (gameModeSelect.value === 'guessing') {
                    difficultySelection.classList.remove('hidden');
                    targetUrlSection.classList.add('hidden');
                } else {
                    difficultySelection.classList.add('hidden');
                    targetUrlSection.classList.remove('hidden');
                }
            } else {
                targetUrlSettingDiv.classList.add('hidden');
                ctrlFCheckbox.disabled = true;
                gameModeSelect.disabled = true;
                difficultySelect.disabled = true;
                if (roomInfo.settings) {
                    ctrlFCheckbox.checked = roomInfo.settings.allow_ctrl_f;
                    gameModeSelect.value = roomInfo.settings.game_mode || 'navigation';
                    difficultySelect.value = roomInfo.settings.difficulty || 'easy';
                    if (gameModeSelect.value === 'guessing') {
                        difficultySelection.classList.remove('hidden');
                        targetUrlSection.classList.add('hidden');
                    } else {
                        difficultySelection.classList.add('hidden');
                        targetUrlSection.classList.remove('hidden');
                    }
                } else {
                    ctrlFCheckbox.checked = true;
                    gameModeSelect.value = 'navigation';
                    difficultySelect.value = 'easy';
                    difficultySelection.classList.add('hidden');
                    targetUrlSection.classList.remove('hidden');
                }
            }
            currentRoomPlayerInfos = roomInfo.player_info || {};
        }

        function updateCtrlFCheckbox(isAllowed) {
            const ctrlFCheckbox = document.getElementById('allow-ctrl-f-checkbox');
            if (ctrlFCheckbox) {
                ctrlFCheckbox.checked = isAllowed;
                if (!isHost) ctrlFCheckbox.disabled = true;
            }
        }

        let searchTimeout;
        function searchWikipedia(query) {
            fetch(`/api/search-wikipedia?query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => displaySuggestions(data.suggestions || []))
                .catch(error => { console.error('æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error); document.getElementById('search-suggestions').classList.add('hidden'); });
        }
        function displaySuggestions(suggestions) {
            const suggestionsDiv = document.getElementById('search-suggestions');
            suggestionsDiv.innerHTML = '';
            if (suggestions.length === 0) { suggestionsDiv.classList.add('hidden'); return; }
            suggestions.forEach(suggestion => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                const title = document.createElement('div');
                title.className = 'suggestion-title';
                title.textContent = suggestion.title;
                const urlDiv = document.createElement('div');
                urlDiv.className = 'suggestion-url';
                try { urlDiv.textContent = decodeURIComponent(suggestion.url); } catch (e) { urlDiv.textContent = suggestion.url; }
                item.appendChild(title); item.appendChild(urlDiv);
                item.addEventListener('click', () => selectSuggestion(suggestion));
                suggestionsDiv.appendChild(item);
            });
            suggestionsDiv.classList.remove('hidden');
        }
        function selectSuggestion(suggestion) {
            document.getElementById('room-target-search-input').value = suggestion.title;
            document.getElementById('room-target-url-input').value = suggestion.url;
            document.getElementById('search-suggestions').classList.add('hidden');
            if (roomId && isHost) {
                socket.emit('set_target_url', { room_id: roomId, target_url: suggestion.url });
            }
        }

        function startGame(data) {
            switchScreen(roomScreen, gameScreen);
            hideGoalNotification();
            if (iframeOverlay) iframeOverlay.style.display = 'none';

            startUrl = data.start_url;
            targetUrl = data.target_url;
            currentPage = startUrl;
            moveCount = 0;
            gamePath = [startUrl];

            gameStartTime = Date.now();
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 1000);

            // â˜… 4. startGame ã§ latestGameState ã‚’åˆæœŸåŒ– (socket.on('game_started')å†…ã§ã‚‚è‰¯ã„ãŒå¿µã®ãŸã‚)
            if (data.game_state) latestGameState = data.game_state;

            document.getElementById('target-page-name').textContent = decodeURIComponent(targetUrl).split('/').pop();

            const gameMode = roomSettings.game_mode;
            const gameModeDisplay = document.getElementById('game-mode-display');
            const navigationTargetSpan = document.getElementById('navigation-target');
            const guessingTargetSpan = document.getElementById('guessing-target');
            const answerFormDiv = document.getElementById('answer-form');
            const gameMovesDiv = document.getElementById('game-moves');
            const gameGuessCountDiv = document.getElementById('game-guess-count');

            if (gameMode === 'navigation') {
                gameModeDisplay.textContent = 'ãƒ¢ãƒ¼ãƒ‰: ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³';
                navigationTargetSpan.classList.remove('hidden');
                guessingTargetSpan.classList.add('hidden');
                answerFormDiv.classList.add('hidden');
                gameMovesDiv.classList.remove('hidden');
                gameGuessCountDiv.classList.add('hidden');
            } else if (gameMode === 'guessing') {
                gameModeDisplay.textContent = 'ãƒ¢ãƒ¼ãƒ‰: ãƒšãƒ¼ã‚¸åå½“ã¦';
                navigationTargetSpan.classList.add('hidden');
                guessingTargetSpan.classList.remove('hidden');
                answerFormDiv.classList.remove('hidden');
                gameMovesDiv.classList.add('hidden');
                gameGuessCountDiv.classList.remove('hidden');
                guessCount = 0;
            }

            updateStats();

            let frameUrl = `/proxy?url=${encodeURIComponent(startUrl)}`;
            if (gameMode === 'guessing') {
                frameUrl += `&mode=guessing&room_id=${roomId}`;
            }
            document.getElementById('game-frame').src = frameUrl;

            // ã‚®ãƒ–ã‚¢ãƒƒãƒ—ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            const giveUpBtn = document.getElementById('give-up-btn');
            if (giveUpBtn) giveUpBtn.style.display = 'inline-block';

            if (data.game_state) updateAllPlayersProgress(data.game_state);
        }

        // â˜… 3. updateTimer é–¢æ•°ã®ä¿®æ­£
        function updateTimer() {
            if (!gameStartTime || gameScreen.classList.contains('hidden')) { // ã‚²ãƒ¼ãƒ ç”»é¢ã§ãªã„å ´åˆã¯ã‚¿ã‚¤ãƒãƒ¼æ›´æ–°ã‚’ã‚¹ã‚­ãƒƒãƒ—
                if (timerInterval) clearInterval(timerInterval); // å®‰å…¨ã®ãŸã‚ã‚¯ãƒªã‚¢
                return;
            }
            const elapsedMs = Date.now() - gameStartTime;
            const elapsedSec = Math.floor(elapsedMs / 1000);
            const minutes = Math.floor(elapsedSec / 60);
            const seconds = elapsedSec % 60;
            document.getElementById('current-time').textContent = `çµŒéæ™‚é–“: ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é€²æ—ãƒªã‚¹ãƒˆã®ã‚¿ã‚¤ãƒãƒ¼ã‚‚æ›´æ–°
            if (latestGameState && !gameScreen.classList.contains('hidden')) { // ã‚²ãƒ¼ãƒ ç”»é¢è¡¨ç¤ºä¸­ã®ã¿æ›´æ–°
                updateAllPlayersProgress(latestGameState);
            }
        }


        function updateStats() {
            if (roomSettings.game_mode === 'navigation') {
                document.getElementById('game-moves').textContent = `ç§»å‹•å›æ•°: ${moveCount}`;
            } else if (roomSettings.game_mode === 'guessing') {
                document.getElementById('game-guess-count').textContent = `æ¨æ¸¬å›æ•°: ${guessCount}`;
            }
        }

        function updateAllPlayersProgress(gameState) {
            const progressList = document.getElementById('player-progress-list');
            if (!progressList) return; // è¦ç´ ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
            progressList.innerHTML = '';
            if (!gameState || !gameState.player_states) {
                progressList.innerHTML = '<div style="padding: 15px; color: #777;">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
                return;
            }

            Object.entries(gameState.player_states).forEach(([pid, state], index) => {
                const playerCard = document.createElement('div');
                let cardClasses = 'player-card';
                if (state.finished) cardClasses += ' finished';
                if (pid === playerId) cardClasses += ' current-player';
                if (state.eliminated) cardClasses += ' eliminated';
                if (state.gave_up) cardClasses += ' eliminated'; // ã‚®ãƒ–ã‚¢ãƒƒãƒ—ã‚‚è„±è½ã¨åŒã˜ã‚¹ã‚¿ã‚¤ãƒ«
                playerCard.className = cardClasses;
                // animationDelay ã¯åˆå›æç”»æ™‚ã®ã¿æœ‰åŠ¹ã«ã—ãŸã„ãŒã€ã“ã“ã§ã¯ç°¡ç•¥åŒ–
                // playerCard.style.animationDelay = `${index * 0.1}s`; 

                const playerInfoDetail = currentRoomPlayerInfos[pid];
                const rawPlayerName = playerInfoDetail ? playerInfoDetail.username : (state.username || `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${pid.substr(0, 4)}`);

                const playerNameDiv = document.createElement('div');
                playerNameDiv.className = 'player-name';
                const nameSpan = document.createElement('span');
                nameSpan.textContent = rawPlayerName;
                playerNameDiv.appendChild(nameSpan);
                const statusTextSpan = document.createElement('span');
                statusTextSpan.className = 'status-text';
                let statusTextContent = pid === playerId ? ' (ã‚ãªãŸ)' : '';
                if (state.gave_up) statusTextContent += ' (ã‚®ãƒ–ã‚¢ãƒƒãƒ—)';
                else if (state.eliminated) statusTextContent += ' (è„±è½)';
                else if (state.finished) statusTextContent += ' (ã‚´ãƒ¼ãƒ«)';
                statusTextSpan.textContent = statusTextContent.trim();
                if (statusTextSpan.textContent) { playerNameDiv.appendChild(document.createTextNode(' ')); playerNameDiv.appendChild(statusTextSpan); }
                playerCard.appendChild(playerNameDiv);

                const playerMovesDiv = document.createElement('div');
                playerMovesDiv.className = 'player-info-item';
                const movesLabel = document.createElement('strong');
                movesLabel.textContent = roomSettings.game_mode === 'guessing' ? 'æ­£è§£æ•°: ' : 'ç§»å‹•å›æ•°: ';
                playerMovesDiv.appendChild(movesLabel);
                playerMovesDiv.appendChild(document.createTextNode(state.moves));
                playerCard.appendChild(playerMovesDiv);

                const playerTimeDiv = document.createElement('div');
                playerTimeDiv.className = 'player-info-item';
                const timeLabel = document.createElement('strong');
                timeLabel.textContent = 'æ™‚é–“: ';
                playerTimeDiv.appendChild(timeLabel);
                let elapsedTime = '00:00';
                if (gameState.started_at) {
                    const startTime = gameState.started_at * 1000; // Unix timestamp (seconds to ms)
                    // state.finish_time ã‚‚ç§’å˜ä½ã® Unix timestamp ã¨ä»®å®š
                    const endTime = (state.finished && state.finish_time) ? state.finish_time * 1000 : Date.now();
                    const elapsedMs = endTime - startTime;
                    const elapsedSec = Math.floor(elapsedMs / 1000);
                    const minutes = Math.floor(elapsedSec / 60);
                    const seconds = elapsedSec % 60;
                    elapsedTime = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                }
                playerTimeDiv.appendChild(document.createTextNode(elapsedTime));
                playerCard.appendChild(playerTimeDiv);
                progressList.appendChild(playerCard);
            });
        }

        function playerFinished(data) {
            if (data.game_state) updateAllPlayersProgress(data.game_state); // ã“ã‚Œã¯æœ€æ–°ã®çŠ¶æ…‹ã§æ›´æ–°

            const finishedPlayerInfo = currentRoomPlayerInfos[data.player_id];
            const playerName = finishedPlayerInfo ? finishedPlayerInfo.username : `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ (${data.player_id.substring(0, 4)}...)`;

            if (data.player_id === playerId) {
                showGoalNotification(`ğŸ‰ ç›®æ¨™é”æˆï¼ ğŸ‰`, `ã‚ãªãŸã¯ ${data.rank} ä½ã§ã™ã€‚ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®çµ‚äº†ã‚’å¾…ã£ã¦ã„ã¾ã™...`);
                if (iframeOverlay) iframeOverlay.style.display = 'block';
                
                // ã‚®ãƒ–ã‚¢ãƒƒãƒ—ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
                const giveUpBtn = document.getElementById('give-up-btn');
                if (giveUpBtn) giveUpBtn.style.display = 'none';
            } else {
                showPlayerGoalToast(playerName, data.rank);
            }
        }

        function showGoalNotification(mainMessage, subMessage = "") {
            if (goalNotification) {
                document.getElementById('goal-notification-main-text').textContent = mainMessage;
                document.getElementById('goal-notification-sub-text').textContent = subMessage;
                goalNotification.style.display = 'block';
            }
        }
        function hideGoalNotification() {
            if (goalNotification) goalNotification.style.display = 'none';
        }

        function showPlayerGoalToast(playerName, rank) {
            const toast = document.createElement('div');
            toast.style.cssText = 'position:fixed; bottom:20px; right:20px; background-color:#e8f5e9; color:#2e7d32; padding:12px 20px; border-radius:5px; box-shadow:0 4px 8px rgba(0,0,0,0.2); z-index:9999; max-width:300px; font-weight:bold; border:1px solid #a5d6a7; display:flex; align-items:center; animation:fadeIn 0.5s, fadeOut 0.5s 5s; animation-fill-mode:forwards;';
            const icon = document.createElement('span');
            icon.innerHTML = 'ğŸ†';
            icon.style.marginRight = '10px';
            icon.style.fontSize = '20px';
            const message = document.createElement('span');
            message.textContent = `${playerName} ãŒ ${rank} ä½ã§ã‚´ãƒ¼ãƒ«ã—ã¾ã—ãŸï¼`;
            toast.appendChild(icon);
            toast.appendChild(message);
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 5500);
        }

        function showResults(data) {
            if (timerInterval) clearInterval(timerInterval);
            latestGameState = null; // çµæœè¡¨ç¤ºæ™‚ã¯ä¸è¦
            const resultsTableBody = document.getElementById('results-table-body');
            resultsTableBody.innerHTML = '';

            data.results.forEach(result => {
                const row = document.createElement('tr');
                if (result.rank === 1) row.classList.add('rank-1');
                else if (result.rank === 2) row.classList.add('rank-2');
                else if (result.rank === 3) row.classList.add('rank-3');

                const timeTaken = result.time_taken ? formatTime(result.time_taken) : '-';
                const rankTd = document.createElement('td');
                rankTd.className = 'rank'; rankTd.textContent = result.rank;
                const playerTd = document.createElement('td');
                let statusText = result.player_id === playerId ? '(ã‚ãªãŸ)' : '';
                if (result.gave_up) statusText += ' (ã‚®ãƒ–ã‚¢ãƒƒãƒ—)';
                else if (result.eliminated) statusText += ' (è„±è½)';
                playerTd.textContent = `${result.username} ${statusText}`;
                if (result.eliminated || result.gave_up) row.style.backgroundColor = '#ffebee';
                const movesTd = document.createElement('td');
                movesTd.textContent = `${result.moves}å›`;
                const timeTd = document.createElement('td');
                timeTd.textContent = timeTaken;
                const pathTd = document.createElement('td');
                const pathButton = document.createElement('button');
                pathButton.className = 'view-path-btn btn'; pathButton.style.padding = '5px 10px'; pathButton.style.fontSize = '0.8em';
                pathButton.textContent = 'ãƒ«ãƒ¼ãƒˆè¡¨ç¤º'; pathButton.dataset.path = JSON.stringify(result.path);
                pathTd.appendChild(pathButton);
                row.appendChild(rankTd); row.appendChild(playerTd); row.appendChild(movesTd); row.appendChild(timeTd); row.appendChild(pathTd);
                resultsTableBody.appendChild(row);
            });

            const modalContent = resultsModal.querySelector('.modal-content');
            const oldActionButtonsContainer = modalContent.querySelector('div.action-buttons-container');
            if (oldActionButtonsContainer) oldActionButtonsContainer.remove();

            const actionButtonsContainer = document.createElement('div');
            actionButtonsContainer.className = 'action-buttons-container';
            actionButtonsContainer.style.cssText = 'display:flex; justify-content:center; gap:15px; margin-top:20px;';

            const resetGameBtn = document.createElement('button');
            resetGameBtn.className = 'btn'; resetGameBtn.style.backgroundColor = '#4CAF50';
            resetGameBtn.textContent = 'æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’å§‹ã‚ã‚‹'; resetGameBtn.onclick = resetGame;

            const backToLobbyBtnClone = document.createElement('button');
            backToLobbyBtnClone.id = "back-to-lobby-btn-modal";
            backToLobbyBtnClone.className = "btn";
            backToLobbyBtnClone.textContent = "ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹";
            backToLobbyBtnClone.onclick = function () {
                const rModalContent = resultsModal.querySelector('.modal-content');
                rModalContent.classList.remove('fade-in'); rModalContent.classList.add('fade-out');
                setTimeout(() => {
                    resultsModal.classList.add('hidden'); rModalContent.classList.remove('fade-out');
                    switchScreen(gameScreen, lobbyScreen);
                    socket.emit('leave_room_request');
                    loadAvailableRooms();
                }, parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--transition-speed')) * 1000 || 500);
            };
            actionButtonsContainer.appendChild(resetGameBtn);
            actionButtonsContainer.appendChild(backToLobbyBtnClone);
            modalContent.appendChild(actionButtonsContainer);

            document.querySelectorAll('.view-path-btn').forEach(button => {
                button.addEventListener('click', function () { displayPathInModal(JSON.parse(this.dataset.path)); });
            });

            createConfetti();
            resultsModal.classList.remove('hidden');
            modalContent.classList.add('fade-in');
        }

        function displayPathInModal(path) {
            const pathModal = document.createElement('div');
            pathModal.className = 'modal'; pathModal.style.zIndex = '1001';
            const pathContent = document.createElement('div');
            pathContent.className = 'modal-content'; pathContent.style.textAlign = 'left';
            const h2 = document.createElement('h2');
            h2.textContent = 'ãŸã©ã£ãŸãƒ«ãƒ¼ãƒˆ';
            const ol = document.createElement('ol');
            ol.style.paddingLeft = '20px';
            path.forEach(url => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = url; a.target = '_blank';
                a.textContent = decodeURIComponent(url).split('/').pop();
                li.appendChild(a); ol.appendChild(li);
            });
            const closeButton = document.createElement('button');
            closeButton.className = 'btn'; closeButton.textContent = 'é–‰ã˜ã‚‹';
            closeButton.style.marginTop = '20px'; closeButton.onclick = () => pathModal.remove();
            pathContent.appendChild(h2); pathContent.appendChild(ol); pathContent.appendChild(closeButton);
            pathModal.appendChild(pathContent); document.body.appendChild(pathModal);
        }

        function createConfetti() {
            const confettiCount = 100;
            const colors = ['#6e8efb', '#a777e3', '#ffcc00', '#ff7675', '#55efc4', '#00cec9'];
            const modalContent = document.querySelector('#results-modal .modal-content');
            if (!modalContent) { console.error('Modal content for confetti not found'); return; }
            const existingConfetti = modalContent.querySelectorAll('.confetti');
            existingConfetti.forEach(c => c.remove());
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                const size = Math.random() * 8 + 4;
                confetti.style.width = size + 'px'; confetti.style.height = size * 1.5 + 'px';
                confetti.style.opacity = Math.random() * 0.6 + 0.4;
                confetti.style.animation = `confetti-fall ${Math.random() * 2 + 3}s ${Math.random() * 1.5}s ease-in 1 forwards`;
                modalContent.appendChild(confetti);
            }
        }

        function handleFrameLoad() {
            const frame = document.getElementById('game-frame');
            try {
                const frameDoc = frame.contentDocument || frame.contentWindow.document;
                if (!frameDoc) return;

                Array.from(frameDoc.getElementsByTagName('script')).forEach(script => script.remove());

                if (roomSettings && !roomSettings.allow_ctrl_f && frame.contentWindow) {
                    frame.contentWindow.addEventListener('keydown', function (e) {
                        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                            e.preventDefault();
                            if (!ctrlFWarningShown) {
                                socket.emit('ctrl_f_violation');
                            }
                        }
                    });
                }

                Array.from(frameDoc.getElementsByTagName('a')).forEach(link => {
                    link.addEventListener('click', async function (e) {
                        e.preventDefault();
                        if (iframeOverlay && iframeOverlay.style.display === 'block') return;

                        const href = this.getAttribute('href');
                        if (href) {
                            let fullUrl;
                            if (href.startsWith('/wiki/')) fullUrl = `https://ja.wikipedia.org${href}`;
                            else if (href.includes('wikipedia.org')) fullUrl = href;
                            else return;

                            if (isValidWikipediaArticle(fullUrl)) {
                                await navigateToPage(fullUrl);
                            }
                        }
                    });
                });

                const style = frameDoc.createElement('style');
                style.textContent = `a { cursor: pointer !important; color: blue !important; text-decoration: underline !important; } a:hover { text-decoration: underline !important; color: darkblue !important; }`;
                frameDoc.head.appendChild(style);
            } catch (e) {
                console.warn('ãƒ•ãƒ¬ãƒ¼ãƒ å‡¦ç†ã‚¨ãƒ©ãƒ¼ (ã‚¯ãƒ­ã‚¹ã‚ªãƒªã‚¸ãƒ³ã®å¯èƒ½æ€§):', e);
            }
        }

        async function navigateToPage(clickedUrl, isGuessingModeNextPage = false) {
            if (!(roomSettings.game_mode === 'guessing' && isGuessingModeNextPage)) {
                socket.emit('player_move', { url: clickedUrl });
            }

            let frameUrl = `/proxy?url=${encodeURIComponent(clickedUrl)}`;
            if (roomSettings.game_mode === 'guessing') {
                frameUrl += `&mode=guessing&room_id=${roomId}`;
            }
            document.getElementById('game-frame').src = frameUrl;
        }

        function isValidWikipediaArticle(url) {
            try {
                const urlObj = new URL(url);
                const path = urlObj.pathname;
                return path.startsWith('/wiki/') && !path.includes(':') && !path.includes('Special:') &&
                    !path.includes('Wikipedia:') && !path.includes('File:') && !path.includes('Template:');
            } catch (e) { return false; }
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            const millis = Math.floor((remainingSeconds - Math.floor(remainingSeconds)) * 1000);
            return `${String(minutes).padStart(2, '0')}:${String(Math.floor(remainingSeconds)).padStart(2, '0')}.${String(millis).padStart(3, '0')}`;
        }

        function switchScreen(currentScreen, nextScreen) {
            const transitionSpeed = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--transition-speed')) * 1000 || 500;
            if (currentScreen) {
                currentScreen.classList.add('fade-out');
                setTimeout(() => {
                    currentScreen.classList.add('hidden');
                    currentScreen.classList.remove('fade-out');
                    if (nextScreen) {
                        nextScreen.classList.remove('hidden');
                        nextScreen.classList.add('fade-in');
                        setTimeout(() => nextScreen.classList.remove('fade-in'), transitionSpeed);
                    }
                }, transitionSpeed);
            } else if (nextScreen) {
                nextScreen.classList.remove('hidden');
                nextScreen.classList.add('fade-in');
                setTimeout(() => nextScreen.classList.remove('fade-in'), transitionSpeed);
            }
        }

        function showEliminationToast(playerName) {
            const toast = document.createElement('div');
            toast.style.cssText = 'position:fixed; bottom:20px; right:20px; background-color:#ffebee; color:#d32f2f; padding:12px 20px; border-radius:5px; box-shadow:0 4px 8px rgba(0,0,0,0.2); z-index:9999; max-width:300px; font-weight:bold; border:1px solid #ef9a9a; display:flex; align-items:center; animation:fadeIn 0.5s, fadeOut 0.5s 5s; animation-fill-mode:forwards;';
            const icon = document.createElement('span');
            icon.innerHTML = 'âš ï¸'; icon.style.marginRight = '10px'; icon.style.fontSize = '20px';
            const message = document.createElement('span');
            message.textContent = `${playerName} ãŒCtrl+Fä½¿ç”¨ã®ãŸã‚è„±è½ã—ã¾ã—ãŸ`;
            toast.appendChild(icon); toast.appendChild(message); document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 5500);
        }

        function resetGame() {
            const rModalContent = resultsModal.querySelector('.modal-content');
            rModalContent.classList.remove('fade-in'); rModalContent.classList.add('fade-out');
            setTimeout(() => {
                resultsModal.classList.add('hidden'); rModalContent.classList.remove('fade-out');
                socket.emit('reset_room', { room_id: roomId });
            }, parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--transition-speed')) * 1000 || 500);
        }

        function submitAnswer() {
            if (roomSettings.game_mode !== 'guessing') return;
            const answer = document.getElementById('answer-input').value.trim();
            if (!answer) return;
            socket.emit('submit_answer', { room_id: roomId, answer: answer, current_url: currentPage });
            document.getElementById('answer-input').value = '';
        }

        function showCorrectAnswerDialog(correctTitle) {
            const dialog = document.createElement('div');
            dialog.className = 'modal'; dialog.style.zIndex = '2000';
            const content = document.createElement('div');
            content.className = 'modal-content'; content.style.maxWidth = '400px';
            content.style.backgroundColor = '#e8f5e9'; content.style.border = '2px solid #4caf50';
            const title = document.createElement('h3');
            title.textContent = 'ğŸ‰ æ­£è§£ï¼'; title.style.color = '#2e7d32';
            const message = document.createElement('p');
            message.textContent = `æ­£è§£ã¯ã€Œ${correctTitle}ã€ã§ã—ãŸï¼`;
            message.style.marginBottom = '20px'; message.style.fontSize = '18px';
            const buttonDiv = document.createElement('div');
            buttonDiv.style.textAlign = 'center';
            const okButton = document.createElement('button');
            okButton.className = 'btn'; okButton.textContent = 'OK';
            okButton.style.backgroundColor = '#4caf50'; okButton.onclick = () => dialog.remove();
            buttonDiv.appendChild(okButton); content.appendChild(title); content.appendChild(message); content.appendChild(buttonDiv);
            dialog.appendChild(content); document.body.appendChild(dialog);
        }

        function showWrongAnswerDialog() {
            const toast = document.createElement('div');
            toast.style.cssText = 'position:fixed; top:20px; left:50%; transform:translateX(-50%); background-color:#ffebee; color:#d32f2f; padding:10px 20px; border-radius:5px; box-shadow:0 2px 4px rgba(0,0,0,0.2); font-weight:bold; z-index:9999;';
            toast.textContent = 'âŒ ä¸æ­£è§£ã§ã™ã€‚ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã—ã¦ãã ã•ã„ã€‚';
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0'; toast.style.transition = 'opacity 0.5s ease';
                setTimeout(() => toast.remove(), 500);
            }, 2000);
        }

        function showPlayerAnsweredToast(playerName) {
            const toast = document.createElement('div');
            toast.style.cssText = 'position:fixed; bottom:20px; right:20px; background-color:#e8f5e9; color:#2e7d32; padding:12px 20px; border-radius:5px; box-shadow:0 4px 8px rgba(0,0,0,0.2); z-index:9999; max-width:300px; font-weight:bold; border:1px solid #a5d6a7; display:flex; align-items:center; animation:fadeIn 0.5s, fadeOut 0.5s 5s; animation-fill-mode:forwards;';
            const icon = document.createElement('span');
            icon.innerHTML = 'ğŸ¯'; icon.style.marginRight = '10px'; icon.style.fontSize = '20px';
            const message = document.createElement('span');
            message.textContent = `${playerName} ãŒãƒšãƒ¼ã‚¸åã‚’å½“ã¦ã¾ã—ãŸï¼`;
            toast.appendChild(icon); toast.appendChild(message); document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 5500);
        }

        function showPlayerLeftToast(playerName) {
            const toast = document.createElement('div');
            toast.style.cssText = 'position:fixed; bottom:20px; right:20px; background-color:#fff3e0; color:#e65100; padding:12px 20px; border-radius:5px; box-shadow:0 4px 8px rgba(0,0,0,0.2); z-index:9999; max-width:300px; font-weight:bold; border:1px solid #ffb74d; display:flex; align-items:center; animation:fadeIn 0.5s, fadeOut 0.5s 5s; animation-fill-mode:forwards;';
            const icon = document.createElement('span');
            icon.innerHTML = 'ğŸšª'; icon.style.marginRight = '10px'; icon.style.fontSize = '20px';
            const message = document.createElement('span');
            message.textContent = `${playerName} ãŒã‚²ãƒ¼ãƒ ã‹ã‚‰é›¢è„±ã—ã¾ã—ãŸ`;
            toast.appendChild(icon); toast.appendChild(message); document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 5500);
        }

        function showPlayerGaveUpToast(playerName) {
            const toast = document.createElement('div');
            toast.style.cssText = 'position:fixed; bottom:20px; right:20px; background-color:#ffebee; color:#c62828; padding:12px 20px; border-radius:5px; box-shadow:0 4px 8px rgba(0,0,0,0.2); z-index:9999; max-width:300px; font-weight:bold; border:1px solid #ef9a9a; display:flex; align-items:center; animation:fadeIn 0.5s, fadeOut 0.5s 5s; animation-fill-mode:forwards;';
            const icon = document.createElement('span');
            icon.innerHTML = 'ğŸ³ï¸'; icon.style.marginRight = '10px'; icon.style.fontSize = '20px';
            const message = document.createElement('span');
            message.textContent = `${playerName} ãŒã‚®ãƒ–ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ`;
            toast.appendChild(icon); toast.appendChild(message); document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 5500);
        }

        // ã‚®ãƒ–ã‚¢ãƒƒãƒ—ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
        function showGiveUpConfirmDialog() {
            const dialog = document.createElement('div');
            dialog.className = 'modal';
            dialog.style.zIndex = '2000';
            const content = document.createElement('div');
            content.className = 'modal-content';
            content.style.maxWidth = '400px';
            content.style.backgroundColor = '#fff8e1';
            content.style.border = '2px solid #ff9800';
            
            const title = document.createElement('h3');
            title.textContent = 'âš ï¸ ã‚®ãƒ–ã‚¢ãƒƒãƒ—ç¢ºèª';
            title.style.color = '#e65100';
            
            const message = document.createElement('p');
            message.textContent = 'æœ¬å½“ã«ã‚®ãƒ–ã‚¢ãƒƒãƒ—ã—ã¾ã™ã‹ï¼Ÿã‚®ãƒ–ã‚¢ãƒƒãƒ—ã™ã‚‹ã¨æœ€ä¸‹ä½ã¨ã—ã¦æ‰±ã‚ã‚Œã€ã‚²ãƒ¼ãƒ ã‹ã‚‰é™¤å¤–ã•ã‚Œã¾ã™ã€‚';
            message.style.marginBottom = '20px';
            message.style.lineHeight = '1.6';
            
            const buttonDiv = document.createElement('div');
            buttonDiv.style.textAlign = 'center';
            buttonDiv.style.display = 'flex';
            buttonDiv.style.gap = '10px';
            buttonDiv.style.justifyContent = 'center';
            
            const cancelButton = document.createElement('button');
            cancelButton.className = 'btn';
            cancelButton.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
            cancelButton.style.backgroundColor = '#6c757d';
            cancelButton.onclick = () => dialog.remove();
            
            const confirmButton = document.createElement('button');
            confirmButton.className = 'btn';
            confirmButton.textContent = 'ã‚®ãƒ–ã‚¢ãƒƒãƒ—';
            confirmButton.style.backgroundColor = '#f44336';
            confirmButton.onclick = () => {
                dialog.remove();
                handleGiveUp();
            };
            
            buttonDiv.appendChild(cancelButton);
            buttonDiv.appendChild(confirmButton);
            content.appendChild(title);
            content.appendChild(message);
            content.appendChild(buttonDiv);
            dialog.appendChild(content);
            document.body.appendChild(dialog);
        }

        // ã‚®ãƒ–ã‚¢ãƒƒãƒ—å‡¦ç†
        function handleGiveUp() {
            if (socket && roomId) {
                socket.emit('player_give_up', { room_id: roomId });
                // ã‚®ãƒ–ã‚¢ãƒƒãƒ—å¾Œã¯æ“ä½œã‚’ç„¡åŠ¹åŒ–
                if (iframeOverlay) iframeOverlay.style.display = 'block';
                
                // ã‚®ãƒ–ã‚¢ãƒƒãƒ—é€šçŸ¥ã‚’è¡¨ç¤º
                showGoalNotification('ğŸ³ï¸ ã‚®ãƒ–ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ', 'ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®çµ‚äº†ã‚’å¾…ã£ã¦ã„ã¾ã™...');
            }
        }
    </script>
</body>

</html>